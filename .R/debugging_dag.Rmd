---
title: "debugging_dag"
output: github_document
date: "2024-01-31"
---
Install packages
```{r}
library(tibble)
library(simulateGP)
library(dplyr)
library(TwoSampleMR)
```

```{r}
dgmodel <- function(nid, #making large sample size so enough individuals for case control analysis
  h2_known, #h-squared value (form of r-squared) https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4667278/
  h2_unknown, #to total 0.25 of total H-squared (form of r-squared) https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4667278/
  d_prev, #glioma prevalence https://www.ncbi.nlm.nih.gov/books/NBK441874/#:~:text=In%20the%20United%20States%2C%20there,the%20least%20malignant%20brain%20tumors.
  #b_lr0=rev_mr_result[row,]$beta,  #adding rev MR results into data generating model
  gr_maf, #need to estimate this allele frequency
  rsq_gr0,   
  rsq_gc0, 
  rsq_lr0,
  b_u1r1, 
  b_u1l, 
  b_u2c1, 
  b_u2l, 
  b_dr1, #non causal marker increases beta 1 in disease
  b_dc1, #causal marker increases beta 1 in disease
  b_c0c1, 
  b_r0r1, 
  b_u2c0, 
  b_u1r0, 
  b_u1d, 
  b_u2d, 
  b_gcc0,
  b_gcc1, #set to this as beta of c0 is this 
  var_l, #estimated variance of liability to be 1
  vp, nsnp)  #assuming variance of genetic liability is 1
{
  u1 <- rnorm(nid) 
  u2 <- rnorm(nid) 
gwashits <- tribble(
    ~beta, ~af,
    0.26, 0.54
)
 gc <- sapply(gwashits$af, \(x) rbinom(nid, 2, x)) 

#rsq_gcl <- 2*gwashits$af*(1-gwashits$af) * gwashits$beta^2 / var_l

#rsq_gcc0 <- sqrt(rsq_gcl)
#rsq_c0l <- sqrt(rsq_gcl)

#Var_c0 <- rep(1, nrow(gwashits))
 
#b_gcc0 <- sqrt(rsq_gcl * Var_c0 / (2*gwashits$af*(1-gwashits$af)))
#b_c0l <- sqrt(rsq_c0l * var_l / Var_c0)


c0 <- gc * b_gcc0 + u2*b_u2c0 + rnorm(nid, sd=sqrt(1-b_gcc0^2-b_u2c0^2))

rsq_prs <- h2_known - (0.1)^2
prs <- rnorm(nid, mean=0, sd=sqrt(vp*h2_known)) 

l <- gc %*% gwashits$beta +prs * sqrt(rsq_prs) +u2*b_u2l 
gr <- make_geno(nid, nsnp, gr_maf)
l_for_r0 <- matrix(l,             
               nrow = nrow(l),
               ncol = ncol(gr))
  r0 <- gr * sqrt(rsq_gr0) + l_for_r0 * sqrt(rsq_lr0) + u1 * b_u1r0 + rnorm(nid, sd=sqrt(1-rsq_gr0-rsq_lr0^2-b_u1r0^2)) 
  prob_l <- simulateGP::gx_to_gp(gx=scale(l), h2x=rsq_prs + b_c0l^2 + b_u1d^2 + b_u2d^2, prev = d_prev) 
 
  d <- rbinom(nid, 1, prob_l) 
  d <- abs(d-1) 

  c1 <-c0 *b_c0c1 + u2 * b_u2c1 + d * b_dc1 + rnorm(nid, sd=sqrt(1 - b_u2c1^2- b_c0c1^2))
  r1 <-  r0 * b_r0r1 + u1 * b_u1r1 + d * b_dr1 + rnorm(nid, sd=sqrt(1-b_r0r1^2-b_u1r1^2)) 
   phen <- tibble(
    u1, u2, r0[,1], r1[,1], c0[,1], c1[,1], prs, l, prob_l, d
  )
  return(list(geno_gc=gc,geno_gr=gr, phen=phen))} 

dgmodel_check <- function(dat)
{
  print(tibble(
    col = names(dat$phen),
    vars = apply(dat$phen, 2, var), 
    means = colMeans(dat$phen)
  ), n=25)
  print(cor(dat$phen$prs, dat$phen$l)^2)
}
dgmodel_analysis <- function(dat, ncase, ncontrol, protein_gwas, rev_mr_result)
{
  phen <- dat$phen
  res_all <- bind_rows( 
    fast_assoc(y=phen$d, x=phen$prs) %>% as_tibble() %>% mutate(x="prs", y="d"),
    fast_assoc(y=phen$`c0[, 1]`, x=phen$d) %>% as_tibble() %>% mutate(x="c0_1", y="d"),
    fast_assoc(y=phen$`r0[, 1]`, x=phen$d) %>% as_tibble() %>% mutate(x="r0", y="d"),
    fast_assoc(y=phen$prs, x=phen$`c0[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="c0_1"),
    fast_assoc(y=phen$prs, x=phen$`r0[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="r0"),
    fast_assoc(y=phen$`c1[, 1]`, x=phen$d) %>% as_tibble() %>% mutate(x="c1_1", y="d"),
    fast_assoc(y=phen$`r1[, 1]`, x=phen$d) %>% as_tibble() %>% mutate(x="r1", y="d"),
    fast_assoc(y=phen$prs, x=phen$`c1[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="c1_1"),
    fast_assoc(y=phen$prs, x=phen$`r1[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="r1")
  ) %>%
    mutate(study="all")
  
  obs <- bind_rows(phen[phen$d == 0,][1:ncontrol,], phen[phen$d == 1,][1:ncase,])  
  case <- length(subset(obs$d, obs$d==1))
  paste("Number of cases: ", case) 
  control <- length(subset(obs$d, obs$d==0))
  paste("Number of controls: ", control)
  res_obs <- bind_rows(
    fast_assoc(y=obs$d, x=obs$prs) %>% as_tibble() %>% mutate(x="prs", y="d"),
    fast_assoc(y=obs$`c0[, 1]`, x=obs$d) %>% as_tibble() %>% mutate(x="c0_1", y="d"),
    fast_assoc(y=obs$`r0[, 1]`, x=obs$d) %>% as_tibble() %>% mutate(x="r0", y="d"),
    fast_assoc(y=obs$prs, x=obs$`c0[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="c0_1"),
    fast_assoc(y=obs$prs, x=obs$`r0[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="r0"),
    fast_assoc(y=obs$`c1[, 1]`, x=obs$d) %>% as_tibble() %>% mutate(x="c1_1", y="d"),
    fast_assoc(y=obs$`r1[, 1]`, x=obs$d) %>% as_tibble() %>% mutate(x="r1", y="d"),
    fast_assoc(y=obs$prs, x=obs$`c1[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="c1_1"),
    fast_assoc(y=obs$prs, x=obs$`r1[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="r1"),
  )  %>%
    mutate(study="observational")

  prot <- phen[phen$d==0,][1:protein_gwas, ] 
  res_protein <- bind_rows(
    fast_assoc(y=prot$d, x=prot$prs) %>% as_tibble() %>% mutate(x="prs", y="d"),
    fast_assoc(y=prot$`c0[, 1]`, x=prot$d) %>% as_tibble() %>% mutate(x="c0_1", y="d"),
    fast_assoc(y=prot$`r0[, 1]`, x=prot$d) %>% as_tibble() %>% mutate(x="r0", y="d"),
    fast_assoc(y=prot$prs, x=prot$`c0[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="c0_1"),
    fast_assoc(y=prot$prs, x=prot$`r0[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="r0"),
    fast_assoc(y=prot$`c1[, 1]`, x=prot$d) %>% as_tibble() %>% mutate(x="c1_1", y="d"),
    fast_assoc(y=prot$`r1[, 1]`, x=prot$d) %>% as_tibble() %>% mutate(x="r1", y="d"),
    fast_assoc(y=prot$prs, x=prot$`c1[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="c1_1"),
    fast_assoc(y=prot$prs, x=prot$`r1[, 1]`) %>% as_tibble() %>% mutate(x="prs", y="r1"),
  ) %>%
    mutate(study="protein_gwas")
  out_all <- paste0(rev_mr_result[row,]$prot, "_res_all.csv")
  write.csv(res_all, file = out_all, row.names = FALSE, quote = FALSE)
  out_obs <- paste0(rev_mr_result[row,]$prot, "_res_obs.csv")
  write.csv(res_obs, file = out_obs, row.names = FALSE, quote = FALSE)
  out_protein <- paste0(rev_mr_result[row,]$prot, "_res_protein.csv")
  write.csv(res_protein, file = out_protein, row.names = FALSE, quote = FALSE)
  return(bind_rows(res_all, res_obs, res_protein))
} 


ivw_analysis <- function(dat){
  phen <- dat$phen
  gen_gr <- dat$geno_gr
mr_dat <- get_effs(phen$prs, phen$`r1[, 1]`, gen_gr) #had to set r0[,1] so that it is pulling first column 
print("Reverse MR")
mr(mr_dat, metho=c("mr_ivw")) %>% str()
gen_gc <- dat$geno_gc
mr_dat <- get_effs(phen$`c1[, 1]`, phen$d, gen_gc) 
print("Forward MR")
mr(mr_dat, metho=c("mr_ivw", "mr_wald_ratio")) %>% str()

print("2SLS")
summary(systemfit::systemfit(phen$prs ~ phen$r0, method="2SLS", inst = ~gen)) 
print("Observational")
summary(lm(phen$prs ~ phen$r0))
}
##observational case control data
ind <- do.call(paste0, dat$phen) %in% do.call(paste0, obs)
genosubset <- dat$geno_gc[ind, ]
geno_mat <- data.matrix(genosubset)
phenosubset <- dat$phen[ind, ]
stopifnot(nrow(genosubset) == nrow(phenosubset))
mr_dat <- get_effs(phenosubset$`c1[, 1]`, phenosubset$d, geno_mat)
print("Forward MR")
mr(mr_dat, metho=c("mr_ivw", "mr_wald_ratio")) %>% str()

##only cases
ind <- dat$phen$d ==1
genosubset <- dat$geno_gc[ind, ]
geno_mat <- data.matrix(genosubset)
phenosubset <- dat$phen[ind, ]
stopifnot(nrow(genosubset) == nrow(phenosubset))
mr_dat <- get_effs(phenosubset$`c0[, 1]`, phenosubset$d, geno_mat) 
print("Forward MR")
mr(mr_dat, metho=c("mr_ivw", "mr_wald_ratio")) %>% str()
```

```{r}
rev_mr_result <- tribble(
  ~beta, ~prot, ~rsq_lr0,
 0.0880, "HMGCS1", 0.2040
)

for(row in 1:nrow(rev_mr_result)){
dat <- dgmodel(nid=1000000, #making large sample size so enough individuals for case control analysis
  h2_known=0.06, #h-squared value (form of r-squared) https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4667278/
  h2_unknown=0.19, #to total 0.25 of total H-squared (form of r-squared) https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4667278/
  d_prev=6/100000, #glioma prevalence https://www.ncbi.nlm.nih.gov/books/NBK441874/#:~:text=In%20the%20United%20States%2C%20there,the%20least%20malignant%20brain%20tumors.
  #b_lr0=rev_mr_result[row,]$beta,  #adding rev MR results into data generating model
  gr_maf=0.20, #need to estimate this allele frequency
  rsq_gr0=0,   
  rsq_gc0=0, 
  rsq_lr0=rev_mr_result$rsq_lr0,
  b_u1r1=0, 
  b_u1l=0, 
  b_u2c1=0, 
  b_u2l=0, 
  b_dr1=0, #non causal marker stays the same in disease
  b_dc1=1, #causal marker increases beta 1 in disease
  b_c0c1=1, 
  b_r0r1=1, 
  b_u2c0=0, 
  b_u1r0=0, 
  b_u1d=0, 
  b_u2d=0, 
  b_gcc0=0.13,
  b_gcc1=0.13, #set to this as beta of c0 is this 
  var_l=1, #estimated variance of liability to be 1
  vp=1, 
  nsnp=99) #estimated variance of protein to be 1

dgmodel_check(dat)

dgmodel_analysis(dat, ncase=12496, ncontrol=18190, protein_gwas = 3301, rev_mr_result)}
ivw_analysis(dat)
```


This takes equal case and control numbers - c1 and d
```{r}
ind <- do.call(paste0, dat$phen) %in% do.call(paste0, obs)
genosubset <- dat$geno_gc[ind, ]
geno_mat <- data.matrix(genosubset)
phenosubset <- dat$phen[ind, ]
stopifnot(nrow(genosubset) == nrow(phenosubset))
mr_dat <- get_effs(phenosubset$`c1[, 1]`, phenosubset$d, geno_mat)
print("Forward MR")
mr(mr_dat, metho=c("mr_ivw", "mr_wald_ratio")) %>% str()
```
With no unmeasured confounders:

[1] "Forward MR"
Analysing 'X' on 'Y'
'data.frame':	1 obs. of  9 variables:
 $ id.exposure: chr "X"
 $ id.outcome : chr "Y"
 $ outcome    : chr "Y"
 $ exposure   : chr "X"
 $ method     : chr "Wald ratio"
 $ nsnp       : num 1
 $ b          : num 2.43
 $ se         : num 0.0365
 $ pval       : num 0
 
 
 This takes equal case and control numbers - r0 and d
```{r}
ind <- do.call(paste0, dat$phen) %in% do.call(paste0, obs)
genosubset <- dat$geno_gr[ind, ]
geno_mat <- data.matrix(genosubset)
phenosubset <- dat$phen[ind, ]
stopifnot(nrow(genosubset) == nrow(phenosubset))
mr_dat <- get_effs(phenosubset$`r0[, 1]`, phenosubset$d, geno_mat)
print("Reverse MR")
mr(mr_dat, metho=c("mr_ivw", "mr_wald_ratio")) %>% str()
```



TO DO:
Forward MR not coming out with expected result - do we need more cases to make this better?
Change DAG so gc doesn't go to c1 and same for r1