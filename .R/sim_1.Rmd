---
title: "Simulation 1"
author: "Lily Andrews"
date: "2023-11-28"
output: github_document
---
Install packages
Install packages
```{r message=FALSE, warning=FALSE}
library(tibble)
library(simulateGP)
library(dplyr)
library(TwoSampleMR)
library(parallel)
library(data.table)
library(ggplot2)
```

Simulation 1

Data generating model using results from UK Biobank pQTL dataset (https://www.nature.com/articles/s41586-023-06592-6) and glioma GWAS (https://www.nature.com/articles/ng.3823):
```{r}
rmarkdown::render("sims_functions.Rmd")

param  <- expand.grid(
  n_prot=34557,
  af = c(0.2,0.4),
  b=0.0879946, 
  rsq_lr0=0.0052923,
  nestedcasecontrol=2000,
  x1=0.1,
  sims=1:2
)

sims <- lapply(1:nrow(param), function(i){
  
print(param[i,])
print("before training dat")
training_dat <- dgmodel(nid=60000, 
b_gcc0=0.13,
b_u2c0=0,
gr_maf=param$af[i],
nsnp=99,
h2_known=0.2,
h2_unknown=0.19,
b_c0l=0,
b_u2l=0,
rsq_gr0=0,
rsq_lr0=param$rsq_lr0[i],
b_u1r0=0,
b_u1d=0,
b_u2d=0,
d_prev=3/10,
b_c0c1=1,
b_u2c1=0,
b_dc1=1,
b_r0r1=1,
b_u1r1=0,
b_dr1=0,
b_dx1=param$x1[i]) 
print("after training dat")

p1_rev <- rev_mr_prot_p1(dat=training_dat, n_protein_gwas=param$n_prot[i], ncontrol=18190, ncase=12496)
p2_rev <- rev_mr_prot_p2(dat=training_dat, n_protein_gwas=param$n_prot[i], ncontrol=18190, ncase=12496)
p3_rev <- rev_mr_prot_p3(dat=training_dat, n_protein_gwas=param$n_prot[i], ncontrol=18190, ncase=12496)
betas_rev <- rbind(p1_rev, p2_rev, p3_rev)
betas_rev<-as.data.frame(betas_rev)
for (row in 1:nrow(betas_rev)){
  if(betas_rev$pval[row]<0.05){
   
  } else{
    betas_rev[row,] <- list(0, 0, 0, 0, 0, 0, 0, 0, 0)
}}

p1_fwd <- fwd_mr_prot_p1(dat=training_dat, n_protein_gwas=param$n_prot[i], ncontrol=18190, ncase=12496)
p2_fwd <- fwd_mr_prot_p2(dat=training_dat, n_protein_gwas=param$n_prot[i], ncontrol=18190, ncase=12496)
p3_fwd <- fwd_mr_prot_p3(dat=training_dat, n_protein_gwas=param$n_prot[i], ncontrol=18190, ncase=12496)
betas_fwd <- rbind(p1_fwd, p2_fwd, p3_fwd)
betas_fwd<-as.data.frame(betas_fwd)
for (row in 1:nrow(betas_fwd)){
  if(betas_fwd$pval[row]<0.05){
   
  } else{
    betas_fwd[row,] <- list(0, 0, 0, 0, 0, 0, 0, 0, 0)
}}

p1_cc <- nested_case_control_p1(dat=training_dat, nestedcase=param$nestedcasecontrol[i], nestedcontrol=param$nestedcasecontrol[i])
p2_cc <- nested_case_control_p2(dat=training_dat, nestedcase=param$nestedcasecontrol[i], nestedcontrol=param$nestedcasecontrol[i])
p3_cc <- nested_case_control_p3(dat=training_dat, nestedcase=param$nestedcasecontrol[i], nestedcontrol=param$nestedcasecontrol[i])
cc <- rbind(p1_cc, p2_cc, p3_cc)
betas_cc<- as.data.frame(cc)
for (row in 1:nrow(betas_cc)){
  if(betas_cc$pval[row]<0.05){
  }
  else{
    betas_cc[row,] <- list(0, 0, 0, 0, 0, 0)
}}

print("made betas")
testing_dat <- dgmodel(nid=60000, 
b_gcc0=0.13,
b_u2c0=0,
gr_maf=param$af[i],
nsnp=99,
h2_known=0.2,
h2_unknown=0.19,
b_c0l=0,
b_u2l=0,
rsq_gr0=0,
rsq_lr0=param$rsq_lr0[i],
b_u1r0=0,
b_u1d=0,
b_u2d=0,
d_prev=3/10,
b_c0c1=1,
b_u2c1=0,
b_dc1=1,
b_r0r1=1,
b_u1r1=0,
b_dr1=0,
b_dx1=param$x1[i])

print("made tresting dat")
protein_model_rev <- score_model(betas=betas_rev, testing_dat, nid)
protein_model_fwd <- score_model(betas=betas_fwd, testing_dat, nid)
protein_model_cc <- score_model_cc(betas=betas_cc, testing_dat, nid)
print("made protein models")
pscore_df <- data.frame(rev = protein_model_rev, fwd = protein_model_fwd, cc = protein_model_cc)
print(pscore_df)
return(pscore_df) 
}) 

pscore <- data.table()
for (i in 1:nrow(param)){
    row <- sims[[i]]
    pscore <- rbind(pscore, row)
}
```
